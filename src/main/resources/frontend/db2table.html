<script>
    var _hmt = _hmt || [];
    (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?97653e22175b6597a0db85ab2dab22d1";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据库设计</title>
    <style>
        table tr td {
            border: 1px solid;
        }
    </style>
</head>
<div style="float: left">
<textarea cols="30" rows="30" id="dsl" onkeyup="compile(this.value)">
-用户users
账号user_id varchar20
昵称user_name varchar30
密码password varchar16
角色编号role_id int
-角色user_role
角色编号role_id int
名称name varchar20
-商品种类item_type
编号item_type_id int
名称item_type_name varchar30
类别type_id varchar30
-商品单位item_unit
编号item_unit int
名称name varchar10
</textarea><br>
    <p>使用教程：<br>
        ↑按照上面我给的例子做<br>
        -表中文名英文名<br>
        列中文名英文名 数据类型长度<br>
    </p>
    <br>
    <button onclick="ok()"><h3>OK, 下载word</h3></button>
</div>
<h4>预览</h4>
<table id="compiled" style="border: 1px solid">
</table>
<script>
    window.onload = function () {
        compile(document.getElementById("dsl").value)
    }
    /**
     *
     * @type {Table[]}
     */
    const tables = []

    class Table {
        /**
         * @param id{string}
         * @param {string} name
         * @param {Column[]} columns
         */
        constructor(id, name, columns) {
            this.id = id
            this.name = name
            this.columns = columns
        }
    }

    class Column {
        /**
         *
         * @param id{string}
         * @param name{string}
         * @param type{string}
         * @param len{string}
         */
        constructor(id, name, type, len) {
            this.id = id;
            this.name = name
            this.type = type;
            this.len = len;
        }
    }
    function ok(){
        var domain = window.location.hostname;
        // Get the current URL
        let url = 'http://'+domain+':19001/dbTable';
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(tables)
        })
            .then(response => response.blob())
            .then(blob => {
                // Create a blob URL
                let url = window.URL.createObjectURL(blob);
                // Create a link and programmatically click it to download the file
                let a = document.createElement("a");
                a.href = url;
                a.download = 'DbTable.docx';
                a.click();
            })
            .catch((error) => console.error('Error:', error));

    }
    function compile(dsl) {
        tables.length = 0
        let tableNow = new Table("", "", [])
        let rows = dsl.split("\n")
        for (let i = 0; i < rows.length; i++) {
            let row = rows[i].trim();
            let nextRow = rows[i + 1]
            if (row === undefined || row.length === 0)
                continue
            //-的就是表格
            if (row.startsWith("-")) {
                row = row.replaceAll("-", "").trim()
                tableNow = new Table(extractEnglishCharacters(row), extractChineseCharacters(row), [])
                continue
            }
            let tokens = splitBySpaces(row)
            let column = new Column(
                extractEnglishCharacters(tokens[0]),
                extractChineseCharacters(tokens[0]),
                extractEnglishCharacters(tokens[1]),
                extractNumbers(tokens[1]),
            )
            tableNow.columns.push(column)
            //保存最后一个
            if (nextRow === undefined || nextRow.trim().length === 0) {
                tables.push(tableNow)
                break
            }
            //保存上一个表格
            if (nextRow.startsWith("-")) {
                tables.push(tableNow)
            }
        }
        compileToHtml(tables)
        return tables;
    }

    function compileToHtml(tables) {
        let preview = document.getElementById("compiled");
        // Clear the preview
        while (preview.firstChild) {
            preview.removeChild(preview.firstChild);
        }

        for (let table of tables) {
            preview.appendChild(document.createTextNode(table.name))
            // Create and append the header row
            let headerRow = document.createElement("tr");
            ["字段名", "数据类型", "长度", "是否为空", "是否主键", "描述"].forEach(text => {
                let th = document.createElement("th");
                th.textContent = text;
                headerRow.appendChild(th);
            });
            preview.appendChild(headerRow);
            // Create and append the data rows
            for (let i = 0; i < table.columns.length; i++) {
                let col = table.columns[i];
                let tr = document.createElement("tr");
                let isPk = "否";
                let lenStr = col.len;
                if (i === 0)
                    isPk = "是";
                if (col.len.length === 0)
                    lenStr = "——";
                [col.id, col.type, lenStr, "否", isPk.toString(), col.name].forEach(text => {
                    let td = document.createElement("td");
                    td.textContent = text;
                    tr.appendChild(td);
                });
                preview.appendChild(tr);
            }
        }
    }

    function extractChineseCharacters(inputString) {
        let chineseCharacters = inputString.match(/[\p{Script=Han}]/gu);
        return chineseCharacters ? chineseCharacters.join('') : '';
    }

    function extractEnglishCharacters(inputString) {
        let englishCharacters = inputString.match(/[a-z_A-Z\s]/g);
        return englishCharacters ? englishCharacters.join('') : '';
    }

    function extractNumbers(inputString) {
        let numbers = inputString.match(/\d+/g);
        return numbers ? numbers.join('') : '';
    }

    function splitBySpaces(inputString) {
        return inputString.split(/\s+/);
    }

</script>